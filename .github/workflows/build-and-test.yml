name: Build and Test

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - '.devcontainer/**'
      - 'LICENSE'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - '.devcontainer/**'
      - 'LICENSE'
  # Run after Docker image is built (when triggered by Docker workflow completion)
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  # Wait for Docker build workflow to complete if it's running
  wait-for-docker:
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_run'
    steps:
      - name: Wait for Docker build to complete
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'docker-build.yml',
              status: 'in_progress',
              branch: 'main'
            });
            
            if (workflows.data.workflow_runs.length > 0) {
              console.log('Docker build workflow is running, waiting...');
              const runId = workflows.data.workflow_runs[0].id;
              
              // Poll until completion (max 30 minutes)
              let completed = false;
              let iterations = 0;
              const maxIterations = 60; // 30 minutes (60 * 30s)
              while (!completed && iterations < maxIterations) {
                await new Promise(resolve => setTimeout(resolve, 30000)); // Wait 30s
                iterations++;
                const run = await github.rest.actions.getWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: runId
                });
                
                if (run.data.status === 'completed') {
                  completed = true;
                  console.log('Docker build completed with conclusion:', run.data.conclusion);
                  if (run.data.conclusion !== 'success') {
                    core.setFailed('Docker build did not succeed');
                  }
                }
              }
              
              if (!completed) {
                core.setFailed('Timeout: Docker build did not complete within 30 minutes');
              }
            } else {
              console.log('No Docker build workflow is currently running');
            }

  build-and-test:
    runs-on: ubuntu-latest
    needs: wait-for-docker
    if: always() && (needs.wait-for-docker.result == 'success' || needs.wait-for-docker.result == 'skipped')
    container:
      image: ghcr.io/prze-kiesz/modu-core:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --user root
    
    strategy:
      matrix:
        build_type: [Debug, Release]
    
    env:
      CC: gcc
      CXX: g++
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DBUILD_TESTING=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure --verbose

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.build_type }}
          path: |
            build/Testing/Temporary/LastTest.log
            build/Testing/Temporary/LastTestsFailed.log
          if-no-files-found: ignore

      - name: Upload build artifacts
        if: matrix.build_type == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: modu-core-${{ matrix.build_type }}-${{ github.sha }}
          path: |
            build/main/modu-core
            build/main/*/unit_test/*_unittest
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          cd build
          echo "## Test Summary (${{ matrix.build_type }})" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ctest --verbose 2>&1 | tail -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
