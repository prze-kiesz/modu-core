name: Build and Test

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - '.devcontainer/**'
      - 'LICENSE'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - '.devcontainer/**'
      - 'LICENSE'
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/prze-kiesz/modu-core:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    strategy:
      matrix:
        build_type: [Debug, Release]
        compiler: [gcc, clang]
        include:
          - compiler: gcc
            cc: gcc
            cxx: g++
          - compiler: clang
            cc: clang
            cxx: clang++
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure CMake
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DBUILD_TESTING=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure --verbose

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: |
            build/Testing/Temporary/LastTest.log
            build/Testing/Temporary/LastTestsFailed.log
          if-no-files-found: ignore

      - name: Upload build artifacts
        if: matrix.build_type == 'Release' && matrix.compiler == 'gcc'
        uses: actions/upload-artifact@v4
        with:
          name: modu-core-${{ matrix.build_type }}-${{ github.sha }}
          path: |
            build/main/modu-core
            build/main/*/unit_test/*_unittest
          retention-days: 7

  build-without-container:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libgtest-dev \
            libgmock-dev \
            libgoogle-glog-dev \
            libsystemd-dev \
            pkg-config

      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=ON

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure

      - name: Test Summary
        if: always()
        run: |
          cd build
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ctest --verbose 2>&1 | tail -20 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
